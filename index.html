<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>제주교육청 스마트단말 관리 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/compat/firebase-app.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/compat/firebase-database.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-bg: #1e293b;
            --light-bg: #f8fafc;
        }
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--light-bg);
        }
        
        .sidebar {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #334155 100%);
            color: white;
            width: 250px;
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .main-content {
            margin-left: 250px;
            min-height: 100vh;
            background: var(--light-bg);
        }
        
        .header {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .menu-item {
            display: block;
            padding: 0.75rem 1.5rem;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: white;
            border-left-color: var(--primary-color);
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .stats-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2563eb 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
        }
        
        .stats-card.warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
        }
        
        .stats-card.danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table th {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }
        
        .table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .table tr:hover {
            background: #f8fafc;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            width: 100%;
            max-width: 400px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .page-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .page-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .page-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-available {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-rented {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading.show {
            display: flex;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-left-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid transparent;
        }
        
        .alert-success {
            background: #dcfce7;
            border-color: #bbf7d0;
            color: #166534;
        }
        
        .alert-error {
            background: #fee2e2;
            border-color: #fecaca;
            color: #991b1b;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-graduation-cap text-3xl text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">제주교육청 스마트단말 관리 시스템</h1>
                <p class="text-gray-600 mt-2">관리자님 환영합니다</p>
                <div class="text-sm text-gray-500 mt-4">
                    <p>콜센터 번호: 1811-8290</p>
                </div>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">사용자명</label>
                    <input type="text" id="username" class="form-control" placeholder="사용자명을 입력하세요" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">비밀번호</label>
                    <input type="password" id="password" class="form-control" placeholder="비밀번호를 입력하세요" required>
                </div>
                
                <button type="submit" class="btn btn-primary w-full">
                    <i class="fas fa-sign-in-alt"></i>
                    로그인
                </button>
            </form>
            
            <div id="loginError" class="alert alert-error hidden mt-4">
                잘못된 사용자명 또는 비밀번호입니다.
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="p-6 border-b border-gray-600">
                <h2 class="text-xl font-bold text-white">제주교육청</h2>
                <p class="text-sm text-gray-300">스마트단말 관리 시스템</p>
                <div class="mt-2 text-xs text-gray-400">
                    <span id="currentUser">관리자님 환영합니다</span>
                </div>
            </div>
            
            <nav class="mt-6">
                <a href="#" class="menu-item active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt w-5"></i>
                    대여 관리
                </a>
                <a href="#" class="menu-item" data-page="products">
                    <i class="fas fa-box w-5"></i>
                    제품 관리
                </a>
                <a href="#" class="menu-item" data-page="users">
                    <i class="fas fa-users w-5"></i>
                    사용자 관리
                </a>
                <a href="#" class="menu-item" data-page="feedback">
                    <i class="fas fa-comments w-5"></i>
                    피드백 게시판
                </a>
            </nav>
            
            <div class="absolute bottom-4 left-4 right-4">
                <button id="logoutBtn" class="btn btn-danger w-full">
                    <i class="fas fa-sign-out-alt"></i>
                    로그아웃
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 id="pageTitle" class="text-2xl font-bold text-gray-800">대여 관리</h1>
                <div class="text-sm text-gray-600">
                    <span id="currentDateTime"></span>
                </div>
            </div>
            
            <div class="p-6">
                <!-- Dashboard Page -->
                <div id="dashboardPage" class="page">
                    <p class="text-gray-600 mb-6">스마트단말 대여 현황을 관리합니다.</p>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="stats-card">
                            <i class="fas fa-laptop text-4xl mb-4 opacity-80"></i>
                            <h3 class="text-lg font-semibold mb-2">1차 장비 수</h3>
                            <div class="text-3xl font-bold" id="stats1st">0</div>
                        </div>
                        <div class="stats-card success">
                            <i class="fas fa-desktop text-4xl mb-4 opacity-80"></i>
                            <h3 class="text-lg font-semibold mb-2">2차 장비 수</h3>
                            <div class="text-3xl font-bold" id="stats2nd">0</div>
                        </div>
                        <div class="stats-card warning">
                            <i class="fas fa-tablet text-4xl mb-4 opacity-80"></i>
                            <h3 class="text-lg font-semibold mb-2">대여중</h3>
                            <div class="text-3xl font-bold" id="statsRented">0</div>
                        </div>
                        <div class="stats-card danger">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4 opacity-80"></i>
                            <h3 class="text-lg font-semibold mb-2">미 대여중</h3>
                            <div class="text-3xl font-bold" id="statsAvailable">0</div>
                        </div>
                    </div>
                    
                    <!-- Search and Filters -->
                    <div class="card">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="form-label">통합 검색</label>
                                <input type="text" id="rentalSearch" class="form-control" placeholder="관리번호, 학교명, 학생명, 제품명...">
                            </div>
                            <div>
                                <label class="form-label">상태 선택</label>
                                <select id="statusFilter" class="form-control">
                                    <option value="">전체 상태</option>
                                    <option value="대여중">대여중</option>
                                    <option value="미대여중">미대여중</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">차수 선택</label>
                                <select id="phaseFilter" class="form-control">
                                    <option value="">전체 차수</option>
                                    <option value="1차">1차</option>
                                    <option value="2차">2차</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">모델 선택</label>
                                <select id="modelFilter" class="form-control">
                                    <option value="">전체 모델</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="form-label">개인정보동의일자 시작</label>
                                <input type="date" id="dateStart" class="form-control">
                            </div>
                            <div>
                                <label class="form-label">개인정보동의일자 종료</label>
                                <input type="date" id="dateEnd" class="form-control">
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button id="searchBtn" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                                검색
                            </button>
                            <button id="resetBtn" class="btn btn-secondary">
                                <i class="fas fa-undo"></i>
                                초기화
                            </button>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-2 mb-4">
                        <button id="addRentalBtn" class="btn btn-success">
                            <i class="fas fa-plus"></i>
                            새 대여 추가
                        </button>
                        <button id="excelSampleBtn" class="btn btn-primary">
                            <i class="fas fa-download"></i>
                            Excel 샘플
                        </button>
                        <button id="uploadExcelBtn" class="btn btn-warning">
                            <i class="fas fa-upload"></i>
                            Excel 업로드
                        </button>
                        <button id="deleteAllBtn" class="btn btn-danger">
                            <i class="fas fa-trash"></i>
                            전체 삭제
                        </button>
                    </div>
                    
                    <!-- Rentals Table -->
                    <div class="card">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll">
                                    </th>
                                    <th>순번</th>
                                    <th>관리번호</th>
                                    <th>제품시리얼</th>
                                    <th>학교명</th>
                                    <th>학교급</th>
                                    <th>학생명</th>
                                    <th>제품명</th>
                                    <th>상태</th>
                                    <th>메모1</th>
                                    <th>메모2</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="rentalsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                        
                        <div class="pagination" id="rentalsPagination">
                            <!-- Pagination will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Products Page -->
                <div id="productsPage" class="page hidden">
                    <p class="text-gray-600 mb-6">제품 데이터를 관리합니다.</p>
                    
                    <!-- Search -->
                    <div class="card">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">검색</label>
                                <input type="text" id="productSearch" class="form-control" placeholder="차수, 관리번호, 제품명, 시리얼 검색...">
                            </div>
                            <div class="flex items-end gap-2">
                                <button id="productSearchBtn" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                    검색
                                </button>
                                <button id="productResetBtn" class="btn btn-secondary">
                                    <i class="fas fa-undo"></i>
                                    초기화
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-2 mb-4">
                        <button id="addProductBtn" class="btn btn-success">
                            <i class="fas fa-plus"></i>
                            제품 추가
                        </button>
                        <button id="productExcelSampleBtn" class="btn btn-primary">
                            <i class="fas fa-download"></i>
                            Excel 샘플
                        </button>
                        <button id="productUploadExcelBtn" class="btn btn-warning">
                            <i class="fas fa-upload"></i>
                            Excel 업로드
                        </button>
                        <button id="productDeleteAllBtn" class="btn btn-danger">
                            <i class="fas fa-trash"></i>
                            전체 삭제
                        </button>
                    </div>
                    
                    <!-- Products Table -->
                    <div class="card">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAllProducts">
                                    </th>
                                    <th>차수</th>
                                    <th>관리번호</th>
                                    <th>제품명</th>
                                    <th>시리얼</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                        
                        <div class="pagination" id="productsPagination">
                            <!-- Pagination will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Users Page -->
                <div id="usersPage" class="page hidden">
                    <p class="text-gray-600 mb-6">시스템 사용자를 관리합니다.</p>
                    
                    <div class="flex gap-2 mb-4">
                        <button id="addUserBtn" class="btn btn-success">
                            <i class="fas fa-user-plus"></i>
                            사용자 추가
                        </button>
                    </div>
                    
                    <!-- Users Table -->
                    <div class="card">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>사용자명</th>
                                    <th>권한</th>
                                    <th>생성일</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Feedback Page -->
                <div id="feedbackPage" class="page hidden">
                    <p class="text-gray-600 mb-6">피드백 및 의견을 관리합니다.</p>
                    
                    <div class="flex gap-2 mb-4">
                        <button id="addPostBtn" class="btn btn-success">
                            <i class="fas fa-pen"></i>
                            새 글 작성
                        </button>
                    </div>
                    
                    <!-- Posts List -->
                    <div class="card">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>번호</th>
                                    <th>제목</th>
                                    <th>작성자</th>
                                    <th>작성일</th>
                                    <th>조회수</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="feedbackTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Rental Modal -->
    <div id="addRentalModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">대여 정보 수정</h2>
                <button class="close text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addRentalForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">관리번호</label>
                        <input type="text" id="rentalManagementNo" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">제품시리얼</label>
                        <input type="text" id="rentalSerial" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">학교명</label>
                        <input type="text" id="rentalSchool" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">학교급</label>
                        <select id="rentalSchoolLevel" class="form-control" required>
                            <option value="">선택하세요</option>
                            <option value="초등학교">초등학교</option>
                            <option value="중학교">중학교</option>
                            <option value="고등학교">고등학교</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">학생명</label>
                        <input type="text" id="rentalStudent" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">제품명</label>
                        <input type="text" id="rentalProduct" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">상태</label>
                        <select id="rentalStatus" class="form-control" required>
                            <option value="대여중">대여중</option>
                            <option value="미대여중">미대여중</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">메모1</label>
                        <input type="text" id="rentalMemo1" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">메모2</label>
                        <input type="text" id="rentalMemo2" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">학생생년월일</label>
                        <input type="date" id="rentalBirthDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">학생연락처</label>
                        <input type="text" id="rentalPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">개인정보동의일자</label>
                        <input type="date" id="rentalConsentDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">보호자명</label>
                        <input type="text" id="rentalGuardianName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">관계</label>
                        <select id="rentalRelation" class="form-control">
                            <option value="">선택하세요</option>
                            <option value="부모">부모</option>
                            <option value="조부모">조부모</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">보호자연락처</label>
                        <input type="text" id="rentalGuardianPhone" class="form-control">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">기타사항</label>
                    <textarea id="rentalEtc" class="form-control" rows="3"></textarea>
                </div>
                
                <!-- Accessories Section -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-cog mr-2"></i>
                        악세사리 관리
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-plug mr-1"></i>
                                충전기
                            </label>
                            <select id="chargerStatus" class="form-control">
                                <option value="양호">양호</option>
                                <option value="훼손">훼손</option>
                                <option value="완파">완파</option>
                                <option value="분실">분실</option>
                                <option value="초기미포함">초기미포함</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-cable-car mr-1"></i>
                                충전케이블
                            </label>
                            <select id="cableStatus" class="form-control">
                                <option value="양호">양호</option>
                                <option value="훼손">훼손</option>
                                <option value="완파">완파</option>
                                <option value="분실">분실</option>
                                <option value="초기미포함">초기미포함</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-usb mr-1"></i>
                                USB 랜 젠더
                            </label>
                            <select id="usbStatus" class="form-control">
                                <option value="양호">양호</option>
                                <option value="훼손">훼손</option>
                                <option value="완파">완파</option>
                                <option value="분실">분실</option>
                                <option value="초기미포함">초기미포함</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-mouse mr-1"></i>
                                마우스
                            </label>
                            <select id="mouseStatus" class="form-control">
                                <option value="양호">양호</option>
                                <option value="훼손">훼손</option>
                                <option value="완파">완파</option>
                                <option value="분실">분실</option>
                                <option value="초기미포함">초기미포함</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-shopping-bag mr-1"></i>
                                가방
                            </label>
                            <select id="bagStatus" class="form-control">
                                <option value="양호">양호</option>
                                <option value="훼손">훼손</option>
                                <option value="완파">완파</option>
                                <option value="분실">분실</option>
                                <option value="초기미포함">초기미포함</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-mobile-alt mr-1"></i>
                                케이스
                            </label>
                            <select id="caseStatus" class="form-control">
                                <option value="양호">양호</option>
                                <option value="훼손">훼손</option>
                                <option value="완파">완파</option>
                                <option value="분실">분실</option>
                                <option value="초기미포함">초기미포함</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        저장
                    </button>
                    <button type="button" class="btn btn-secondary close">
                        <i class="fas fa-times"></i>
                        취소
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">제품 추가</h2>
                <button class="close text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addProductForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">차수</label>
                        <select id="productPhase" class="form-control" required>
                            <option value="">선택하세요</option>
                            <option value="1차">1차</option>
                            <option value="2차">2차</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">관리번호</label>
                        <input type="text" id="productManagementNo" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">제품명</label>
                        <input type="text" id="productName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">시리얼</label>
                        <input type="text" id="productSerial" class="form-control" required>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        저장
                    </button>
                    <button type="button" class="btn btn-secondary close">
                        <i class="fas fa-times"></i>
                        취소
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">사용자 추가</h2>
                <button class="close text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addUserForm">
                <div class="form-group">
                    <label class="form-label">사용자명</label>
                    <input type="text" id="newUsername" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">비밀번호</label>
                    <input type="password" id="newPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">권한</label>
                    <select id="newUserRole" class="form-control" required>
                        <option value="">선택하세요</option>
                        <option value="최고관리자">최고관리자</option>
                        <option value="관리자">관리자</option>
                        <option value="사용자">사용자</option>
                    </select>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        저장
                    </button>
                    <button type="button" class="btn btn-secondary close">
                        <i class="fas fa-times"></i>
                        취소
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Post Modal -->
    <div id="addPostModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">새 글 작성</h2>
                <button class="close text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addPostForm">
                <div class="form-group">
                    <label class="form-label">제목</label>
                    <input type="text" id="postTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">내용</label>
                    <textarea id="postContent" class="form-control" rows="6" required></textarea>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        저장
                    </button>
                    <button type="button" class="btn btn-secondary close">
                        <i class="fas fa-times"></i>
                        취소
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Excel 파일 업로드</h2>
                <button class="close text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 mb-4">Excel 파일을 선택하거나 여기에 드래그하세요</p>
                <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden">
                <button type="button" id="selectFileBtn" class="btn btn-primary">
                    <i class="fas fa-file-excel"></i>
                    파일 선택
                </button>
            </div>
            
            <div id="uploadProgress" class="hidden mt-4">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%" id="progressBar"></div>
                </div>
                <p class="text-sm text-gray-600 mt-2">업로드 중...</p>
            </div>
            
            <div class="flex gap-2 mt-6">
                <button type="button" id="uploadBtn" class="btn btn-success" disabled>
                    <i class="fas fa-upload"></i>
                    업로드
                </button>
                <button type="button" class="btn btn-secondary close">
                    <i class="fas fa-times"></i>
                    취소
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQW8SvnYg4R-1IssLlAZ5fJ4382nNztKA",
            authDomain: "jeju-education-system.firebaseapp.com",
            databaseURL: "https://jeju-education-system-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jeju-education-system",
            storageBucket: "jeju-education-system.firebasestorage.app",
            messagingSenderId: "462514623607",
            appId: "1:462514623607:web:afa068226e4f115a4a2272",
            measurementId: "G-YJ3MLN4XH1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Global Variables
        let currentUser = null;
        let currentPage = 'dashboard';
        let rentalsData = [];
        let productsData = [];
        let usersData = [];
        let feedbackData = [];
        let currentRentalPage = 1;
        let currentProductPage = 1;
        let itemsPerPage = 20;

        // Authentication
        const users = {
            'admin': { password: 'admin123', role: '최고관리자' },
            'manager': { password: 'manager123', role: '관리자' },
            'user': { password: 'user123', role: '사용자' }
        };

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const loading = document.getElementById('loading');

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        function initializeApp() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            } else {
                showLoginScreen();
            }

            // Event Listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Login
            loginForm.addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Navigation
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = e.target.closest('.menu-item').dataset.page;
                    navigateToPage(page);
                });
            });

            // Modal Close
            document.querySelectorAll('.modal .close').forEach(btn => {
                btn.addEventListener('click', closeModals);
            });

            // Buttons
            document.getElementById('addRentalBtn').addEventListener('click', () => openModal('addRentalModal'));
            document.getElementById('addProductBtn').addEventListener('click', () => openModal('addProductModal'));
            document.getElementById('addUserBtn').addEventListener('click', () => openModal('addUserModal'));
            document.getElementById('addPostBtn').addEventListener('click', () => openModal('addPostModal'));

            // Excel functions
            document.getElementById('excelSampleBtn').addEventListener('click', downloadRentalSample);
            document.getElementById('productExcelSampleBtn').addEventListener('click', downloadProductSample);
            document.getElementById('uploadExcelBtn').addEventListener('click', () => openUploadModal('rental'));
            document.getElementById('productUploadExcelBtn').addEventListener('click', () => openUploadModal('product'));

            // Forms
            document.getElementById('addRentalForm').addEventListener('submit', handleAddRental);
            document.getElementById('addProductForm').addEventListener('submit', handleAddProduct);
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('addPostForm').addEventListener('submit', handleAddPost);

            // Search and Filters
            document.getElementById('searchBtn').addEventListener('click', searchRentals);
            document.getElementById('resetBtn').addEventListener('click', resetRentalFilters);
            document.getElementById('productSearchBtn').addEventListener('click', searchProducts);
            document.getElementById('productResetBtn').addEventListener('click', resetProductFilters);

            // File Upload
            document.getElementById('selectFileBtn').addEventListener('click', () => {
                document.getElementById('excelFile').click();
            });
            document.getElementById('excelFile').addEventListener('change', handleFileSelect);
            document.getElementById('uploadBtn').addEventListener('click', handleFileUpload);
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    role: users[username].role
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
                loginError.classList.add('hidden');
            } else {
                loginError.classList.remove('hidden');
            }
        }

        function handleLogout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            showLoginScreen();
        }

        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
        }

        function showMainApp() {
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            document.getElementById('currentUser').textContent = `${currentUser.role}님 환영합니다`;
            loadAllData();
        }

        function navigateToPage(page) {
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-page="${page}"]`).classList.add('active');

            // Hide all pages
            document.querySelectorAll('.page').forEach(p => {
                p.classList.add('hidden');
            });

            // Show selected page
            document.getElementById(`${page}Page`).classList.remove('hidden');

            // Update page title
            const titles = {
                'dashboard': '대여 관리',
                'products': '제품 관리',
                'users': '사용자 관리',
                'feedback': '피드백 게시판'
            };
            document.getElementById('pageTitle').textContent = titles[page];
            currentPage = page;

            // Load page data
            if (page === 'dashboard') {
                loadRentals();
                updateStats();
            } else if (page === 'products') {
                loadProducts();
            } else if (page === 'users') {
                loadUsers();
            } else if (page === 'feedback') {
                loadFeedback();
            }
        }

        function updateDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleString('ko-KR', options);
        }

        // Firebase Data Operations
        function loadAllData() {
            showLoading();
            
            Promise.all([
                loadDataFromFirebase('rentals'),
                loadDataFromFirebase('products'),
                loadDataFromFirebase('users'),
                loadDataFromFirebase('feedback')
            ]).then(([rentals, products, users, feedback]) => {
                rentalsData = rentals || [];
                productsData = products || [];
                usersData = users || [];
                feedbackData = feedback || [];
                
                if (currentPage === 'dashboard') {
                    displayRentals();
                    updateStats();
                }
                hideLoading();
            }).catch(error => {
                console.error('데이터 로드 오류:', error);
                hideLoading();
                showAlert('데이터 로드에 실패했습니다.', 'error');
            });
        }

        function loadDataFromFirebase(collection) {
            return new Promise((resolve, reject) => {
                db.ref(collection).once('value')
                    .then(snapshot => {
                        const data = snapshot.val();
                        if (data) {
                            const dataArray = Object.keys(data).map(key => ({
                                id: key,
                                ...data[key]
                            }));
                            resolve(dataArray);
                        } else {
                            resolve([]);
                        }
                    })
                    .catch(reject);
            });
        }

        function saveToFirebase(collection, data) {
            return new Promise((resolve, reject) => {
                const newRef = db.ref(collection).push();
                newRef.set({
                    ...data,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => resolve(newRef.key))
                .catch(reject);
            });
        }

        function updateFirebase(collection, id, data) {
            return new Promise((resolve, reject) => {
                db.ref(`${collection}/${id}`).update({
                    ...data,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => resolve())
                .catch(reject);
            });
        }

        function deleteFromFirebase(collection, id) {
            return new Promise((resolve, reject) => {
                db.ref(`${collection}/${id}`).remove()
                    .then(() => resolve())
                    .catch(reject);
            });
        }

        // Data Display Functions
        function displayRentals(data = rentalsData, page = currentRentalPage) {
            const tbody = document.getElementById('rentalsTableBody');
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = data.slice(startIndex, endIndex);

            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-gray-500 py-8">데이터가 없습니다.</td></tr>';
                return;
            }

            pageData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" value="${item.id}"></td>
                    <td>${startIndex + index + 1}</td>
                    <td><a href="#" class="text-blue-600 hover:underline" onclick="openRentalDetail('${item.id}')">${item.managementNo || ''}</a></td>
                    <td>${item.serial || ''}</td>
                    <td>${item.school || ''}</td>
                    <td>${item.schoolLevel || ''}</td>
                    <td>${item.student || ''}</td>
                    <td>${item.product || ''}</td>
                    <td>
                        <select class="form-control" onchange="updateRentalStatus('${item.id}', this.value)">
                            <option value="대여중" ${item.status === '대여중' ? 'selected' : ''}>대여중</option>
                            <option value="미대여중" ${item.status === '미대여중' ? 'selected' : ''}>미대여중</option>
                        </select>
                    </td>
                    <td>${item.memo1 || ''}</td>
                    <td>${item.memo2 || ''}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editRental('${item.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteRental('${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination('rentalsPagination', data.length, page, (newPage) => {
                currentRentalPage = newPage;
                displayRentals(data, newPage);
            });
        }

        function displayProducts(data = productsData, page = currentProductPage) {
            const tbody = document.getElementById('productsTableBody');
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = data.slice(startIndex, endIndex);

            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8">데이터가 없습니다.</td></tr>';
                return;
            }

            pageData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" value="${item.id}"></td>
                    <td>${item.phase || ''}</td>
                    <td>${item.managementNo || ''}</td>
                    <td>${item.name || ''}</td>
                    <td>${item.serial || ''}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editProduct('${item.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct('${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination('productsPagination', data.length, page, (newPage) => {
                currentProductPage = newPage;
                displayProducts(data, newPage);
            });
        }

        function updatePagination(containerId, totalItems, currentPage, onPageChange) {
            const container = document.getElementById(containerId);
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            container.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => onPageChange(currentPage - 1);
            container.appendChild(prevBtn);

            // Page input
            const pageInput = document.createElement('input');
            pageInput.type = 'number';
            pageInput.min = 1;
            pageInput.max = totalPages;
            pageInput.value = currentPage;
            pageInput.className = 'form-control w-20 text-center';
            pageInput.onchange = (e) => {
                const page = parseInt(e.target.value);
                if (page >= 1 && page <= totalPages) {
                    onPageChange(page);
                }
            };
            container.appendChild(pageInput);

            // Total pages
            const totalPagesSpan = document.createElement('span');
            totalPagesSpan.textContent = `/ ${totalPages}`;
            totalPagesSpan.className = 'text-gray-600';
            container.appendChild(totalPagesSpan);

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => onPageChange(currentPage + 1);
            container.appendChild(nextBtn);
        }

        function updateStats() {
            const stats1st = rentalsData.filter(item => item.phase === '1차').length;
            const stats2nd = rentalsData.filter(item => item.phase === '2차').length;
            const statsRented = rentalsData.filter(item => item.status === '대여중').length;
            const statsAvailable = rentalsData.filter(item => item.status === '미대여중').length;

            document.getElementById('stats1st').textContent = stats1st;
            document.getElementById('stats2nd').textContent = stats2nd;
            document.getElementById('statsRented').textContent = statsRented;
            document.getElementById('statsAvailable').textContent = statsAvailable;
        }

        // CRUD Operations
        function handleAddRental(e) {
            e.preventDefault();
            
            const formData = {
                managementNo: document.getElementById('rentalManagementNo').value,
                serial: document.getElementById('rentalSerial').value,
                school: document.getElementById('rentalSchool').value,
                schoolLevel: document.getElementById('rentalSchoolLevel').value,
                student: document.getElementById('rentalStudent').value,
                product: document.getElementById('rentalProduct').value,
                status: document.getElementById('rentalStatus').value,
                memo1: document.getElementById('rentalMemo1').value,
                memo2: document.getElementById('rentalMemo2').value,
                birthDate: document.getElementById('rentalBirthDate').value,
                phone: document.getElementById('rentalPhone').value,
                consentDate: document.getElementById('rentalConsentDate').value,
                guardianName: document.getElementById('rentalGuardianName').value,
                relation: document.getElementById('rentalRelation').value,
                guardianPhone: document.getElementById('rentalGuardianPhone').value,
                etc: document.getElementById('rentalEtc').value,
                accessories: {
                    charger: document.getElementById('chargerStatus').value,
                    cable: document.getElementById('cableStatus').value,
                    usb: document.getElementById('usbStatus').value,
                    mouse: document.getElementById('mouseStatus').value,
                    bag: document.getElementById('bagStatus').value,
                    case: document.getElementById('caseStatus').value
                }
            };

            showLoading();
            saveToFirebase('rentals', formData)
                .then(() => {
                    hideLoading();
                    closeModals();
                    showAlert('대여 정보가 저장되었습니다.', 'success');
                    loadAllData();
                })
                .catch(error => {
                    hideLoading();
                    console.error('저장 오류:', error);
                    showAlert('저장 중 오류가 발생했습니다.', 'error');
                });
        }

        function handleAddProduct(e) {
            e.preventDefault();
            
            const formData = {
                phase: document.getElementById('productPhase').value,
                managementNo: document.getElementById('productManagementNo').value,
                name: document.getElementById('productName').value,
                serial: document.getElementById('productSerial').value
            };

            showLoading();
            saveToFirebase('products', formData)
                .then(() => {
                    hideLoading();
                    closeModals();
                    showAlert('제품이 저장되었습니다.', 'success');
                    loadAllData();
                })
                .catch(error => {
                    hideLoading();
                    console.error('저장 오류:', error);
                    showAlert('저장 중 오류가 발생했습니다.', 'error');
                });
        }

        function handleAddUser(e) {
            e.preventDefault();
            
            const formData = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                role: document.getElementById('newUserRole').value
            };

            showLoading();
            saveToFirebase('users', formData)
                .then(() => {
                    hideLoading();
                    closeModals();
                    showAlert('사용자가 추가되었습니다.', 'success');
                    loadAllData();
                })
                .catch(error => {
                    hideLoading();
                    console.error('저장 오류:', error);
                    showAlert('저장 중 오류가 발생했습니다.', 'error');
                });
        }

        function handleAddPost(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('postTitle').value,
                content: document.getElementById('postContent').value,
                author: currentUser.username,
                views: 0
            };

            showLoading();
            saveToFirebase('feedback', formData)
                .then(() => {
                    hideLoading();
                    closeModals();
                    showAlert('글이 작성되었습니다.', 'success');
                    loadAllData();
                })
                .catch(error => {
                    hideLoading();
                    console.error('저장 오류:', error);
                    showAlert('저장 중 오류가 발생했습니다.', 'error');
                });
        }

        // Excel Functions
        function downloadRentalSample() {
            const sampleData = [
                ['순번', '관리번호', '제품시리얼', '학교명', '학교급', '학생명', '상태', '메모1', '메모2', '학생생년월일', '학생연락처', '개인정보동의일자', '보호자명', '관계', '보호자연락처', '기타사항'],
                ['1', '2025-0001', 'ABC123', '제주중학교', '중학교', '홍길동', '대여중', '메모1', '메모2', '2010-01-01', '010-1234-5678', '2025-01-01', '홍부모', '부모', '010-9876-5432', '기타사항']
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);
            XLSX.utils.book_append_sheet(wb, ws, "대여관리샘플");
            XLSX.writeFile(wb, "대여관리_업로드샘플.xlsx");
        }

        function downloadProductSample() {
            const sampleData = [
                ['차수', '관리번호', '제품명', '시리얼'],
                ['1차', '2025-0001', '삼성노트북', 'ABC123456'],
                ['2차', '2025-0002', '아이패드', 'DEF789012']
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sampleData);
            XLSX.utils.book_append_sheet(wb, ws, "제품관리샘플");
            XLSX.writeFile(wb, "제품관리_업로드샘플.xlsx");
        }

        function openUploadModal(type) {
            document.getElementById('uploadModal').uploadType = type;
            openModal('uploadModal');
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (file) {
                uploadBtn.disabled = false;
                uploadBtn.textContent = `업로드 (${file.name})`;
            } else {
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> 업로드';
            }
        }

        function handleFileUpload() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            const uploadType = document.getElementById('uploadModal').uploadType;

            if (!file) {
                showAlert('파일을 선택해주세요.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    if (uploadType === 'rental') {
                        processRentalUpload(jsonData);
                    } else if (uploadType === 'product') {
                        processProductUpload(jsonData);
                    }
                } catch (error) {
                    console.error('파일 읽기 오류:', error);
                    showAlert('파일을 읽는 중 오류가 발생했습니다.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processRentalUpload(data) {
            if (data.length < 2) {
                showAlert('올바른 형식의 파일이 아닙니다.', 'error');
                return;
            }

            const headers = data[0];
            const rows = data.slice(1);
            const promises = [];

            showLoading();

            rows.forEach(row => {
                if (row.length > 0 && row[1]) { // 관리번호가 있는 경우만
                    const rentalData = {
                        managementNo: row[1] || '',
                        serial: row[2] || '',
                        school: row[3] || '',
                        schoolLevel: row[4] || '',
                        student: row[5] || '',
                        status: row[6] || '대여중',
                        memo1: row[7] || '',
                        memo2: row[8] || '',
                        birthDate: row[9] || '',
                        phone: row[10] || '',
                        consentDate: row[11] || '',
                        guardianName: row[12] || '',
                        relation: row[13] || '',
                        guardianPhone: row[14] || '',
                        etc: row[15] || ''
                    };

                    promises.push(saveToFirebase('rentals', rentalData));
                }
            });

            Promise.all(promises)
                .then(() => {
                    hideLoading();
                    closeModals();
                    showAlert(`${promises.length}개의 대여 정보가 업로드되었습니다.`, 'success');
                    loadAllData();
                })
                .catch(error => {
                    hideLoading();
                    console.error('업로드 오류:', error);
                    showAlert('업로드 중 오류가 발생했습니다.', 'error');
                });
        }

        function processProductUpload(data) {
            if (data.length < 2) {
                showAlert('올바른 형식의 파일이 아닙니다.', 'error');
                return;
            }

            const headers = data[0];
            const rows = data.slice(1);
            const promises = [];

            showLoading();

            rows.forEach(row => {
                if (row.length > 0 && row[1]) { // 관리번호가 있는 경우만
                    const productData = {
                        phase: row[0] || '',
                        managementNo: row[1] || '',
                        name: row[2] || '',
                        serial: row[3] || ''
                    };

                    promises.push(saveToFirebase('products', productData));
                }
            });

            Promise.all(promises)
                .then(() => {
                    hideLoading();
                    closeModals();
                    showAlert(`${promises.length}개의 제품이 업로드되었습니다.`, 'success');
                    loadAllData();
                })
                .catch(error => {
                    hideLoading();
                    console.error('업로드 오류:', error);
                    showAlert('업로드 중 오류가 발생했습니다.', 'error');
                });
        }

        // Search Functions
        function searchRentals() {
            const searchTerm = document.getElementById('rentalSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const phaseFilter = document.getElementById('phaseFilter').value;
            const modelFilter = document.getElementById('modelFilter').value;
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;

            let filteredData = rentalsData.filter(item => {
                const matchesSearch = !searchTerm || 
                    Object.values(item).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                
                const matchesStatus = !statusFilter || item.status === statusFilter;
                const matchesPhase = !phaseFilter || item.phase === phaseFilter;
                const matchesModel = !modelFilter || item.product === modelFilter;
                
                let matchesDate = true;
                if (dateStart && dateEnd && item.consentDate) {
                    const itemDate = new Date(item.consentDate);
                    const startDate = new Date(dateStart);
                    const endDate = new Date(dateEnd);
                    matchesDate = itemDate >= startDate && itemDate <= endDate;
                }

                return matchesSearch && matchesStatus && matchesPhase && matchesModel && matchesDate;
            });

            currentRentalPage = 1;
            displayRentals(filteredData);
        }

        function resetRentalFilters() {
            document.getElementById('rentalSearch').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('phaseFilter').value = '';
            document.getElementById('modelFilter').value = '';
            document.getElementById('dateStart').value = '';
            document.getElementById('dateEnd').value = '';
            
            currentRentalPage = 1;
            displayRentals();
        }

        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();

            let filteredData = productsData.filter(item => {
                return !searchTerm || 
                    Object.values(item).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
            });

            currentProductPage = 1;
            displayProducts(filteredData);
        }

        function resetProductFilters() {
            document.getElementById('productSearch').value = '';
            currentProductPage = 1;
            displayProducts();
        }

        // Utility Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} fixed top-4 right-4 z-50`;
            alertDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Load data functions
        function loadRentals() {
            displayRentals();
        }

        function loadProducts() {
            displayProducts();
        }

        function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            // Show default users + Firebase users
            const allUsers = [
                { username: 'admin', role: '최고관리자', createdAt: '2024-01-01' },
                { username: 'manager', role: '관리자', createdAt: '2024-01-02' },
                { username: 'user', role: '사용자', createdAt: '2024-01-03' },
                ...usersData
            ];

            allUsers.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>
                        <span class="status-badge ${user.role === '최고관리자' ? 'bg-red-100 text-red-800' : 
                                                    user.role === '관리자' ? 'bg-yellow-100 text-yellow-800' : 
                                                    'bg-green-100 text-green-800'}">
                            ${user.role}
                        </span>
                    </td>
                    <td>${user.createdAt || new Date().toLocaleDateString('ko-KR')}</td>
                    <td>
                        ${user.id ? `
                            <button class="btn btn-primary btn-sm" onclick="editUser('${user.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : '<span class="text-gray-500">기본 사용자</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadFeedback() {
            const tbody = document.getElementById('feedbackTableBody');
            tbody.innerHTML = '';

            if (feedbackData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8">게시글이 없습니다.</td></tr>';
                return;
            }

            feedbackData.forEach((post, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><a href="#" class="text-blue-600 hover:underline" onclick="viewPost('${post.id}')">${post.title}</a></td>
                    <td>${post.author}</td>
                    <td>${new Date(post.createdAt).toLocaleDateString('ko-KR')}</td>
                    <td>${post.views || 0}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deletePost('${post.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update functions for real-time changes
        function updateRentalStatus(id, status) {
            updateFirebase('rentals', id, { status: status })
                .then(() => {
                    // Update local data
                    const rental = rentalsData.find(r => r.id === id);
                    if (rental) {
                        rental.status = status;
                    }
                    updateStats();
                    showAlert('상태가 업데이트되었습니다.', 'success');
                })
                .catch(error => {
                    console.error('상태 업데이트 오류:', error);
                    showAlert('상태 업데이트에 실패했습니다.', 'error');
                });
        }

        // Placeholder functions for edit/delete operations
        function editRental(id) {
            showAlert('수정 기능은 개발 중입니다.', 'warning');
        }

        function deleteRental(id) {
            if (confirm('정말 삭제하시겠습니까?')) {
                deleteFromFirebase('rentals', id)
                    .then(() => {
                        rentalsData = rentalsData.filter(r => r.id !== id);
                        displayRentals();
                        updateStats();
                        showAlert('삭제되었습니다.', 'success');
                    })
                    .catch(error => {
                        console.error('삭제 오류:', error);
                        showAlert('삭제에 실패했습니다.', 'error');
                    });
            }
        }

        function editProduct(id) {
            showAlert('수정 기능은 개발 중입니다.', 'warning');
        }

        function deleteProduct(id) {
            if (confirm('정말 삭제하시겠습니까?')) {
                deleteFromFirebase('products', id)
                    .then(() => {
                        productsData = productsData.filter(p => p.id !== id);
                        displayProducts();
                        showAlert('삭제되었습니다.', 'success');
                    })
                    .catch(error => {
                        console.error('삭제 오류:', error);
                        showAlert('삭제에 실패했습니다.', 'error');
                    });
            }
        }

        function openRentalDetail(id) {
            const rental = rentalsData.find(r => r.id === id);
            if (rental) {
                // Fill the modal with existing data
                document.getElementById('rentalManagementNo').value = rental.managementNo || '';
                document.getElementById('rentalSerial').value = rental.serial || '';
                document.getElementById('rentalSchool').value = rental.school || '';
                document.getElementById('rentalSchoolLevel').value = rental.schoolLevel || '';
                document.getElementById('rentalStudent').value = rental.student || '';
                document.getElementById('rentalProduct').value = rental.product || '';
                document.getElementById('rentalStatus').value = rental.status || '';
                document.getElementById('rentalMemo1').value = rental.memo1 || '';
                document.getElementById('rentalMemo2').value = rental.memo2 || '';
                document.getElementById('rentalBirthDate').value = rental.birthDate || '';
                document.getElementById('rentalPhone').value = rental.phone || '';
                document.getElementById('rentalConsentDate').value = rental.consentDate || '';
                document.getElementById('rentalGuardianName').value = rental.guardianName || '';
                document.getElementById('rentalRelation').value = rental.relation || '';
                document.getElementById('rentalGuardianPhone').value = rental.guardianPhone || '';
                document.getElementById('rentalEtc').value = rental.etc || '';
                
                if (rental.accessories) {
                    document.getElementById('chargerStatus').value = rental.accessories.charger || '양호';
                    document.getElementById('cableStatus').value = rental.accessories.cable || '양호';
                    document.getElementById('usbStatus').value = rental.accessories.usb || '양호';
                    document.getElementById('mouseStatus').value = rental.accessories.mouse || '양호';
                    document.getElementById('bagStatus').value = rental.accessories.bag || '양호';
                    document.getElementById('caseStatus').value = rental.accessories.case || '양호';
                }
                
                // Store the ID for updating
                document.getElementById('addRentalForm').editingId = id;
                openModal('addRentalModal');
            }
        }

        // Initialize real-time listeners
        function initializeRealtimeListeners() {
            db.ref('rentals').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    rentalsData = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    if (currentPage === 'dashboard') {
                        displayRentals();
                        updateStats();
                    }
                }
            });

            db.ref('products').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    productsData = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    if (currentPage === 'products') {
                        displayProducts();
                    }
                }
            });
        }

        // Start real-time listeners after login
        function showMainApp() {
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            document.getElementById('currentUser').textContent = `${currentUser.role}님 환영합니다`;
            initializeRealtimeListeners();
            loadAllData();
        }
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"954a13a57c23d52c","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.6.2","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDmBaG99tGRNbRe5mremZHXWSEFoMxYBGBTVvvFz8%2BMcKWkWCaVh4XwLX7tk8p4ZuSDT5mL%2FIvwoTtJHpwtrEvsdqYjftCpheh7Qd1BaEqyYKEMaY9Sbzctu4aWHzHAZy%2FIdP2RPM2cjVq%2Fdt3MACli9RpHTB1IZTV4Xncd4RbXdBnlb9NH9QU355cFrre5j7iufHpGDZ3xmY3%2BlJkZyioOmWAazMkvPBmhZ8vri9eilXIbufCnl1kj1JPr7an4MXjzlnhz89zGjr0XSN5qnbTSYjlt3n8f2xaDG%2BfvrObI9rv60cwfT4SA39su%2F9g0xtq%2BB2R0dt0Ik%2F4pY%2BzuCZhJs4p5Z3AM1W0sNFk94GhTmhrBBoSzrkXvejD7V1YIImDbXdDMdXvZMpAUesC8gJuo6Th8UO1GmvDLpGwzO7m%2FXT6I3xqnE5iZU4hOVVS0jPZS%2FC%2FwMkfYxcTfgzeIrsqeWTe9kKwB0l4UROQqGa2%2FOnifG%2BeW3VtTaBd0CJ4JfQClHWbZ7xKPGaMUkxxj8gB6c%3D";
        window.__genspark_locale = "ko-KR";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDmBaG99tGRNbRe5mremZHXWSEFoMxYBGBTVvvFz8+McKWkWCaVh4XwLX7tk8p4ZuSDT5mL/IvwoTtJHpwtrEvsdqYjftCpheh7Qd1BaEqyYKEMaY9Sbzctu4aWHzHAZy/IdP2RPM2cjVq/dt3MACli9RpHTB1IZTV4Xncd4RbXdBnlb9NH9QU355cFrre5j7iufHpGDZ3xmY3+lJkZyioOmWAazMkvPBmhZ8vri9eilXIbufCnl1kj1JPr7an4MXjzlnhz89zGjr0XSN5qnbTSYjlt3n8f2xaDG+fvrObI9rv60cwfT4SA39su/9g0xtq+B2R0dt0Ik/4pY+zuCZhJs4p5Z3AM1W0sNFk94GhTmhrBBoSzrkXvejD7V1YIImDbXdDMdXvZMpAUesC8gJuo6Th8UO1GmvDLpGwzO7m/XT6I3xqnE5iZU4hOVVS0jPZS/C/wMkfYxcTfgzeIrsqeWTe9kKwB0l4UROQqGa2/OnifG+eW3VtTaBd0CJ4JfQClHWbZ7xKPGaMUkxxj8gB6c=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
